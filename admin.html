<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Control - Quizz TED</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    /* --- PALETA DARK PRO --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --card-bg: #1e293b;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --primary: #6366f1;
      --accent-gold: #fbbf24;
      --accent-silver: #94a3b8;
      --accent-bronze: #b45309;
      --accent-green: #10b981; 
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: 'Inter', sans-serif; 
      background: var(--bg-gradient); 
      color: var(--text-main); 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      min-height: 100vh;
      padding: 40px 20px; 
    }
    
    .status-bar { 
      margin-bottom: 20px; 
      padding: 8px 20px; 
      background: rgba(255,255,255,0.1); 
      border-radius: 50px; 
      font-weight: 700; 
      color: var(--text-muted); 
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .card { 
      background: var(--card-bg); 
      width: 100%; 
      max-width: 900px; 
      padding: 50px; 
      border-radius: var(--radius); 
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
      text-align: center; 
      border: 1px solid #334155;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    h1 { color: var(--primary); font-size: 2.5rem; font-weight: 800; margin: 0; }
    .big-text { font-size: 2rem; font-weight: 800; margin: 20px 0; line-height: 1.3; color: white; }
    
    /* Grid Jugadores */
    .player-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 30px; }
    .player-chip { 
      background: #334155; 
      padding: 10px 18px; 
      border-radius: 50px; 
      font-weight: 600; 
      border: 1px solid #475569;
      font-size: 0.9rem;
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

    /* Ranking */
    .leaderboard { width: 100%; max-width: 700px; margin: 20px auto 0; }
    .rank-row { 
      background: #334155; 
      padding: 15px 25px; 
      margin: 10px 0; 
      border-radius: 12px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      border: 1px solid #475569; 
      font-size: 1.3rem; 
      font-weight: 700; 
    }
    .rank-number { color: var(--accent-gold); margin-right: 15px; }
    .rank-points { color: #818cf8; }

    /* Estilos del PODIO (Final) */
    .podium { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-bottom: 30px; }
    .podium-spot { display: flex; flex-direction: column; align-items: center; }
    .podium-avatar { font-size: 3rem; margin-bottom: 10px; }
    .podium-bar { width: 100px; border-radius: 10px 10px 0 0; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; font-weight: bold; color: rgba(0,0,0,0.5); }
    .podium-name { margin-top: 10px; font-weight: bold; font-size: 1.2rem; }
    
    .gold { background: var(--accent-gold); height: 180px; box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
    .silver { background: var(--accent-silver); height: 140px; }
    .bronze { background: var(--accent-bronze); height: 100px; }

    /* Bot√≥n Flotante */
    .controls { position: fixed; bottom: 40px; z-index: 100; }
    button { 
      padding: 18px 50px; 
      font-size: 1.2rem; 
      border-radius: 50px; 
      border: none; 
      cursor: pointer; 
      font-weight: 800; 
      color: white; 
      background: var(--primary); 
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); 
      transition: all 0.1s; 
    }
    button:hover { transform: scale(1.05); filter: brightness(1.1); }
    button:active { transform: scale(0.98); }
    .btn-busy { opacity: 0.7; pointer-events: none; cursor: wait; background: #475569; }
    .btn-restart { background: #ef4444 !important; box-shadow: 0 0 20px rgba(239, 68, 68, 0.5) !important; }

    /* Bot√≥n Revelar Respuesta (Estilo secundario) */
    .btn-reveal {
      background: #334155; 
      color: #94a3b8;
      font-size: 1rem;
      padding: 10px 20px;
      margin-top: 20px;
      border: 1px solid #475569;
      box-shadow: none;
    }
    .btn-reveal:hover {
      background: #475569;
      color: white;
      transform: none;
    }

    /* Caja de Respuesta Correcta */
    .correct-answer-box {
      margin-top: 20px;
      padding: 20px;
      background: rgba(16, 185, 129, 0.1); 
      border: 2px solid var(--accent-green);
      border-radius: 12px;
      color: var(--accent-green);
      font-size: 1.5rem;
      font-weight: bold;
      animation: popIn 0.3s;
      /* Elimin√© display:none aqu√≠ para manejarlo por JS */
    }

    /* Contador */
    .counter-circle {
      width: 140px; height: 140px;
      border: 6px solid #334155;
      border-top-color: var(--primary);
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      margin: 20px auto;
      font-size: 3.5rem; font-weight: 800; color: white;
      text-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
    }
  </style>
</head>
<body>

  <div class="status-bar" id="status-text">CONECTANDO...</div>
  
  <div class="card" id="main-display">
    </div>

  <div class="controls">
    <button id="action-btn" onclick="nextState()">‚è© INICIAR JUEGO</button>
  </div>

<script>
  // ‚ö†Ô∏è TU URL DEL SCRIPT AQU√ç ‚ö†Ô∏è
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw69x0Dn-ypruAQzYlLstORveZQYiffrrynHE4PR8OSo6DYRVPR2iL3GW5V8Rwcz5fh_Q/exec";

  // --- PREGUNTAS COMPLETAS ---
  const questions = [
    { q: "1. ¬øCu√°l es el \"principio clave\" que debe guiar cualquier charla seg√∫n el texto?", opts: ["Demostrar superioridad t√©cnica", "Ir a dar, no a recibir", "Conseguir financiamiento", "Terminar exactamente a tiempo"], ans: 1 },
    { q: "2. ¬øPor qu√© el autor afirma que detallar la historia interna de tu laboratorio es un error?", opts: ["Porque es informaci√≥n confidencial", "Porque es aburrido para casi todos los dem√°s", "Porque nadie cree en el √©xito ajeno", "Porque las fotos de edificios distraen"], ans: 1 },
    { q: "3. ¬øPor qu√© la generosidad es la mejor estrategia para un orador?", opts: ["Porque lo hace ver m√°s humilde", "Porque evita preguntas dif√≠ciles", "Porque provoca una respuesta positiva", "Porque acorta la duraci√≥n del evento"], ans: 2 },
    { q: "4. El autor compara la inspiraci√≥n con el amor porque:", opts: ["Es un sentimiento irracional", "Si la buscas directamente, genera rechazo", "Solo ocurre una vez en la vida", "Requiere mucha paciencia"], ans: 1 },
    { q: "5. ¬øCu√°l es la caracter√≠stica principal de la \"Actuaci√≥n Inspirada\"?", opts: ["Hablar con demasiada pasi√≥n", "Usar muchos tecnicismos m√©dicos", "Mucho estilo y muy poca sustancia", "Forzar la voz para conmover"], ans: 2 },
    { q: "6. ¬øQu√© hace el p√∫blico cuando detecta que el objetivo del orador es \"venderle\" algo?", opts: ["Toma notas con m√°s inter√©s", "Interrumpe para pedir detalles", "Se refugia en su celular", "Lo respeta por su ambici√≥n profesional"], ans: 2 },
    { q: "7. Seg√∫n el texto, ¬øcu√°l es la fuente de la verdadera inspiraci√≥n del p√∫blico?", opts: ["Pedirles que crean en tus sue√±os", "Usar trucos de manipulaci√≥n emocional", "La autenticidad y el trabajo generoso", "Una ovaci√≥n de pie coreografiada"], ans: 2 },
    { q: "8. ¬øQu√© mensaje impl√≠cito env√≠a a la audiencia un ponente que alardea de ir \"poco preparado\"?", opts: ["Que es un genio de la improvisaci√≥n", "Que es una persona muy honesta", "Que el tiempo del p√∫blico no importa", "Que el proyecto es muy sencillo"], ans: 2 },
    { q: "9. Un ponente que dice \"dir√© lo que me salga\" por falta de preparaci√≥n, ¬øen qu√© trampa cae?", opts: ["Actuaci√≥n inspirada", "Divagaci√≥n", "Organizaci√≥n aburrida", "Sinceridad acad√©mica"], ans: 1 },
    { q: "10. Para evitar que \"tu organizaci√≥n sea un rollo\", ¬øen qu√© debe centrarse el discurso?", opts: ["En el talento del equipo de trabajo", "En los logros y productos previos", "En el poder de las ideas y el trabajo", "En la complejidad del organigrama"], ans: 2 }
  ];

  let currentState = "LOBBY", currentQIndex = -1, lastServerPlayers = [];
  let forcedState = null; 
  
  // üî• VARIABLE DE MEMORIA PARA EL BOT√ìN üî•
  let answerRevealed = false; 

  setInterval(fetchData, 800);
  fetchData(); // Arranque inmediato

  async function fetchData() {
    try {
      const res = await fetch(SCRIPT_URL);
      const data = await res.json();
      const serverState = data.state;
      lastServerPlayers = data.players || []; 

      if (forcedState) {
        if (serverState === forcedState) {
          forcedState = null;
          document.getElementById('action-btn').classList.remove('btn-busy');
          renderScreen(serverState, lastServerPlayers);
        } else {
          renderScreen(forcedState, lastServerPlayers); 
        }
      } else {
        renderScreen(serverState, lastServerPlayers);
      }
    } catch(e) { }
  }

  // üî• FUNCI√ìN PARA REVELAR Y GUARDAR EL ESTADO üî•
  function revealAnswer() {
    answerRevealed = true; // Guardamos en memoria que YA se mostr√≥
    renderScreen(currentState, lastServerPlayers); // Redibujamos inmediatamente
  }

  function renderScreen(state, players) {
    const display = document.getElementById('main-display');
    const btn = document.getElementById('action-btn');
    const statusText = document.getElementById('status-text');
    
    currentState = state;
    statusText.innerText = forcedState ? "ENVIANDO..." : "EN VIVO: " + state;

    // --- LOBBY ---
    if (state === "LOBBY") {
      btn.innerText = "‚è© INICIAR JUEGO";
      if(!forcedState) btn.className = "";
      
      display.innerHTML = `
        <h1 style="color:white">Lobby de Espera</h1>
        <div class="big-text" style="color:var(--primary)">${players.length} Conectados</div>
        <div class="player-grid">${players.map(p => `<div class="player-chip">${p[2]} ${p[0]}</div>`).join('')}</div>
      `;
    }
    // --- PREGUNTA ---
    else if (state.startsWith("Q")) {
      const idx = parseInt(state.substring(1));
      currentQIndex = idx;
      btn.innerText = "üìä VER RANKING";
      
      let answered = 0;
      if (forcedState && forcedState.startsWith("Q")) {
         answered = 0; 
      } else {
         answered = players.filter(p => p[3] === "SI").length;
      }

      // Datos de la pregunta
      const qData = questions[idx];
      const correctText = qData.opts[qData.ans];

      // üî• L√ìGICA DE VISIBILIDAD BASADA EN LA MEMORIA üî•
      const boxDisplay = answerRevealed ? 'block' : 'none';
      const btnDisplay = answerRevealed ? 'none' : 'inline-block';

      display.innerHTML = `
        <h3 style="color:var(--text-muted); margin:0;">PREGUNTA ${idx+1} / 10</h3>
        <div class="big-text">${qData.q}</div>
        
        <div class="counter-circle">${answered}</div>
        <div style="color:var(--text-muted)">Respuestas recibidas</div>

        <div id="answer-reveal" class="correct-answer-box" style="display: ${boxDisplay}">
           ‚úÖ ${correctText}
        </div>
        
        <button class="btn-reveal" style="display: ${btnDisplay}" onclick="revealAnswer()">
           üëÅÔ∏è MOSTRAR SOLUCI√ìN
        </button>
      `;
    }
    // --- RANKING ---
    else if (state === "RANKING") {
      btn.innerText = "‚è© PR√ìXIMA PREGUNTA";
      const sorted = [...players].sort((a,b) => b[1] - a[1]).slice(0, 5); 
      
      display.innerHTML = `
        <h1 style="color:var(--accent-gold)">üèÜ TOP 5 üèÜ</h1>
        <div class="leaderboard">${sorted.map((p, i) => `
          <div class="rank-row">
            <span><span class="rank-number">#${i+1}</span> ${p[2]} ${p[0]}</span>
            <span class="rank-points">${p[1]}</span>
          </div>`).join('')}
        </div>
      `;
    }
    // --- FINAL ---
    else if (state === "FINAL") {
      btn.innerText = "üîÑ REINICIAR TODO";
      if(!forcedState) btn.className = "btn-restart";
      
      const sortedAll = [...players].sort((a,b) => b[1] - a[1]);
      
      const p1 = sortedAll[0] || ["-", 0, "üëª"];
      const p2 = sortedAll[1] || ["-", 0, ""];
      const p3 = sortedAll[2] || ["-", 0, ""];

      display.innerHTML = `
        <h1 style="font-size:2rem; color:var(--text-muted)">RESULTADOS FINALES</h1>
        
        <div class="podium">
           <div class="podium-spot">
              <div class="podium-avatar">${p2[2]}</div>
              <div class="podium-bar silver">2¬∫</div>
              <div class="podium-name">${p2[0]}</div>
              <div style="font-size:0.9rem; color:#94a3b8">${p2[1]} pts</div>
           </div>
           <div class="podium-spot">
              <div class="podium-avatar" style="font-size:4rem">üëë</div>
              <div class="podium-bar gold">1¬∫</div>
              <div class="podium-name" style="font-size:1.5rem; color:var(--accent-gold)">${p1[0]}</div>
              <div style="font-weight:bold">${p1[1]} pts</div>
           </div>
           <div class="podium-spot">
              <div class="podium-avatar">${p3[2]}</div>
              <div class="podium-bar bronze">3¬∫</div>
              <div class="podium-name">${p3[0]}</div>
              <div style="font-size:0.9rem; color:#94a3b8">${p3[1]} pts</div>
           </div>
        </div>
        
        <div style="margin-top:20px; max-height:200px; overflow-y:auto; width:100%; border-top:1px solid #334155; padding-top:10px;">
           <div style="color:var(--text-muted); margin-bottom:10px; font-size:0.9rem">TABLA GENERAL</div>
           ${sortedAll.slice(3).map((p, i) => `
            <div style="display:flex; justify-content:space-between; padding:8px 15px; border-bottom:1px solid #334155; color:#cbd5e1;">
              <span>#${i+4} ${p[2]} ${p[0]}</span><span>${p[1]} pts</span>
            </div>`).join('')}
        </div>
      `;
    }
  }

  function nextState() {
    if (forcedState) return; 

    let next = "";
    if (currentState === "LOBBY") next = "Q0";
    else if (currentState.startsWith("Q")) next = "RANKING";
    else if (currentState === "RANKING") {
      const nIdx = currentQIndex + 1;
      next = nIdx < questions.length ? "Q" + nIdx : "FINAL";
    }
    else if (currentState === "FINAL") {
      if(confirm("¬øSeguro que quieres borrar todo y reiniciar?")) next = "LOBBY";
      else return;
    }

    if (next) {
      forcedState = next;
      answerRevealed = false; // üî• IMPORTANTE: Reseteamos para la siguiente pregunta
      
      const btn = document.getElementById('action-btn');
      btn.innerText = "‚è≥ PROCESANDO...";
      btn.classList.add('btn-busy');
      renderScreen(next, lastServerPlayers);

      const fd = new FormData();
      fd.append('action', 'admin_set_state');
      fd.append('state', next);
      
      fetch(SCRIPT_URL, { method: 'POST', body: fd }).catch(e => {
        forcedState = null;
        btn.classList.remove('btn-busy');
      });
    }
  }
</script>
</body>
</html>